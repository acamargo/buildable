#!/bin/bash

# Configuration
PROJECT_NAME=<%= name %>
PROJECT_PATH=/r7/$PROJECT_NAME
PIDFILE=$PROJECT_PATH/<%= name %>.pid

# Config where how to start your app!
STARTING_PROJECT=""

if [[ -z $STARTING_PROJECT ]]; then
  printf "ERROR: Project starting configuration not found!\nPlease fix /etc/init.d/$PROJECT_NAME\n"
  exit 1
fi

if [[ -s "/usr/local/rvm/scripts/rvm" ]] ; then
  source "/usr/local/rvm/scripts/rvm"
else
  printf "ERROR: An RVM installation was not found.\n"
  exit 1
fi

pushd $PROJECT_PATH

start_project() {
  echo "Starting $PROJECT_NAME..."

  if running; then
    echo "Could not start, process was already running."
    return 1
  fi

  really_start_project
}

really_start_project() {
  bundle exec bin/dexter start
  errcode=$?
  log_end $errcode "Started."
  return $?
}

stop_project() {
  echo "Stopping $PROJECT_NAME..."

  if ! running ; then
    echo "Could not stop, process wasn't running."
    return 1
  fi

  really_stop_project
}

really_stop_project() {
  $STARTING_PROJECT
  errcode=$?
  log_end $errcode "Stopped."
  return $?
}

log_end() {
  err=$1
  msg=$2
  if [ $err -eq 0 ]; then
    echo $msg
  fi
  return $err
}

restart_project() {
  if running; then
    echo "Stopping"
    really_stop_project || exit 1
  fi
  echo "Starting"
  really_start_project
}

running() {
  if [ -f $PIDFILE ]; then
    pid=`cat $PIDFILE`
    pid_running=`ps -fp $pid > /dev/null`
    $pid_running && return 0
  fi
  return 1
}

case "$1" in
  start)
    start_project && exit 0
    exit 1
    ;;
  stop)
    stop_project && exit 0
    exit 1
    ;;
  restart)
    restart_project && exit 0
    exit 1
    ;;
  *)
  echo "Usage: /etc/init.d/$PROJECT_NAME {start|stop|restart}"
  exit 1
esac
popd
exit 0
